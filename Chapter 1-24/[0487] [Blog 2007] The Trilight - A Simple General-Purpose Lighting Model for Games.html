<html xmlns:o=urn:schemas-microsoft-com:office:office xmlns:w=urn:schemas-microsoft-com:office:word xmlns:st1=urn:schemas-microsoft-com:office:smarttags xmlns=http://www.w3.org/TR/REC-html40 class=hb-loaded style><!--
 Page saved with SingleFile 
 url: https://tomforsyth1000.github.io/papers/trilight/trilight.html 
 saved date: Sun Oct 03 2021 22:11:13 GMT+0800 (中国标准时间)
--><meta charset=utf-8>
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 10">
<meta name=Originator content="Microsoft Word 10">
<link rel=File-List href=https://tomforsyth1000.github.io/papers/trilight/Tri%20light_files/filelist.xml>
<title>The Trilight</title>
<style>@keyframes caretBlink{from{opacity:1.0}to{opacity:0.0}}@keyframes rotateSpinner{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style><link type=image/x-icon rel="shortcut icon" href="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="><style>.sf-hidden{display:none!important}</style><link rel=canonical href=https://tomforsyth1000.github.io/papers/trilight/trilight.html><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:;"><body lang=EN-GB style=tab-interval:36pt huaban_collector_injected=true><o:smarttagtype namespaceuri=urn:schemas-microsoft-com:office:smarttags name=date>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Tom Forsyth</o:Author>
  <o:LastAuthor>Tom Forsyth</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>244</o:TotalTime>
  <o:Created>2007-03-22T08:06:00Z</o:Created>
  <o:LastSaved>2007-03-22T08:06:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1045</o:Words>
  <o:Characters>5961</o:Characters>
  <o:Lines>49</o:Lines>
  <o:Paragraphs>13</o:Paragraphs>
  <o:CharactersWithSpaces>6993</o:CharactersWithSpaces>
  <o:Version>10.4219</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:ApplyBreakingRules/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if !mso]><object
 classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object>
<style>
st1\:*{behavior:url(#ieooui) }
</style>
<![endif]-->
<style class=sf-hidden><!--p.MsoNormal,li.MsoNormal{margin:0cm;margin-bottom:.0001pt;font-size:12.0pt;font-family:"Times New Roman"}h1{margin-top:12.0pt;margin-right:0cm;margin-bottom:3.0pt;margin-left:0cm;page-break-after:avoid;font-size:16.0pt;font-family:Arial}h3{margin-top:12.0pt;margin-right:0cm;margin-bottom:3.0pt;margin-left:0cm;page-break-after:avoid;font-size:13.0pt;font-family:Arial}@page Section1{size:595.3pt 841.9pt;margin:72.0pt 90.0pt 72.0pt 90.0pt;mso-header-margin:35.4pt;mso-footer-margin:35.4pt;mso-paper-source:0}div.Section1{page:Section1}@list l0{mso-list-id:1999259857;mso-list-type:hybrid;mso-list-template-ids:1854695534 134807553 134807555 134807557 134807553 134807555 134807557 134807553 134807555 134807557}@list l0:level1{mso-level-number-format:bullet;mso-level-text:\F0B7;mso-level-tab-stop:36.0pt;mso-level-number-position:left;text-indent:-18.0pt;font-family:Symbol}ul{margin-bottom:0cm}--></style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";}
</style>
<![endif]-->
<div class=Section1>
<h1 align=center style=text-align:center>The <span class=SpellE>Trilight</span></h1>
<h1 align=center style=text-align:center>A simple general-purpose lighting
model for games</h1>
<p class=MsoNormal align=center style=text-align:center>Tom Forsyth, <st1:date month=3 day=22 year=2007>22<sup>nd</sup> March 2007</st1:date></p>
<p class=MsoNormal align=center style=text-align:center><o:p>&nbsp;</o:p></p>
<p>Additional materials: the <a href=https://tomforsyth1000.github.io/papers/trilight/trilight_vs_wraparound.xls>Excel spreadsheet</a> and the <a href=https://tomforsyth1000.github.io/papers/trilight/trilight_demo.zip>Windows demo</a>.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>A �<span class=SpellE>trilight</span>� lighting equation is
a generalisation of a bunch of lighting models people have used in games over
the years:</p>
<h3>Lambert lighting</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=SpellE><span class=GramE>res</span></span> =
colour0 * clamp(N.L)</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=GramE>Your standard half-sphere lighting.</span></p>
<h3>Wrap-around lighting</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=SpellE><span class=GramE>res</span></span> =
colour0 * clamp(<span class=SpellE>N.L+factor</span>)/(1+factor)</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The problem with pure Lambert lighting is that 50% of your
model is completely dark, so the back side doesn�t really show up very well
without adding more lights. A wrap-around light is a very crude simulation of
the light scattering back from the surroundings and lighting the back side to
some extent. This has been used by a variety of games for ages, but the first
place I�ve seen it actually documented was in an aside in an article about Half
Life 2�s lighting model.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>�<span class=GramE>factor</span>� ranges from 0 to 1, with
many games just hard-wiring it to 1.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<h3>Hemispherical lighting</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=SpellE><span class=GramE>res</span></span> =
lerp ( colour2, colour0, (N.L+1)/2 )</p>
<p class=MsoNormal><span style=mso-tab-count:1>����������� </span>= colour2 +
(colour0-colour2) * (N.L+1)/2</p>
<p class=MsoNormal><span style=mso-tab-count:1>����������� </span>=
(colour0+colour2)/2 + (colour0-colour2) * (N.L)/2</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>This has also been used in many games for ages, but the
first time I remember seeing it actually documented was in a talk by Chas Boyd
of Microsoft talking about more interesting light models. This is good for
outdoor scenes � typically the colours are a light blue for the sky and a dark
greenish/brown for the ground. These are the preset colours in the <span class=SpellE>trilight</span> demo.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>Note � I�ve used colour0 and colour2, missing out colour1 to
be consistent with the <span class=SpellE>trilight�s</span> terminology below.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<h3>Bi-directional lighting</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=SpellE><span class=GramE>res</span></span> =
colour0 * clamp(N.L) + colour2 * clamp(-N.L)</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>Yet another lighting model used for ages. The first place I�ve
seen it documented is in an article on <span class=SpellE>Tabula</span> Rasa�s
rendering model in an upcoming GPU Gems book. This is distinct from the
hemispherical lighting model because a lit sphere will have a ring around the
middle between the two lights. In hemispherical lighting, this ring is the
average of the two colours. In bi-directional lighting, this ring is black.
This is fairly simple to see when playing with the demo.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>This lighting model is a cheap approximation of the classic
movie lighting of �key� and �fill� lights. The usual example is at night - a
bright yellow �key� light from a streetlamp and a dark-blue �fill� light from
the night sky to give shape to the dark parts of the character. In fact usually
the fill is not directly opposite the key light, but this is a very similar
effect and is basically free.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<h3>The <span class=SpellE>Trilight</span> Model</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><span class=SpellE><span class=GramE>res</span></span> =
colour0 * clamp(N.L) + colour1 * (1-abs(N.L)) + colour2 * clamp(-N.L)</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The idea of the <span class=SpellE>trilight</span> is to
unify all the above lighting models into one. As a bonus, it also gives more
control than any one of them. In the same way that I�ve never seen the above
lighting models documented until fairly recently, but I know they�ve been used
for ages, I suspect this model has been used by others even before I did (which
I think was sometime in 2002). But I thought it was time to write the thing
down so that everyone could use it.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The <span class=SpellE>trilight</span> is obviously a superset
of Lambert and bi-directional � simply set colour1 and/or colour2 to black.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The <span class=SpellE>trilight</span> is identical to hemispherical
lighting if colour1 = (colour0+colour2)/2. Proof:</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>For N.L &gt;= 0:</p>
<p class=MsoNormal style=text-indent:36pt><span class=SpellE><span class=GramE>trilight</span></span> = colour0 * (N.L) + colour1 * (1-(N.L))</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
colour0 * (N.L) + colour1 - colour1 * (N.L)</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
(colour0-colour1) * (N.L) + colour1</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
(colour0-(colour0+colour2)/2) * (N.L) + (colour0+colour2)/2</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
((colour0-colour2)/2) * (N.L) + (colour0+colour2)/2</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
same as hemispherical</p>
<p class=MsoNormal>For N.L &lt; 0:</p>
<p class=MsoNormal style=text-indent:36pt><span class=SpellE><span class=GramE>trilight</span></span> = colour1 * (1+(N.L)) - colour2 * (N.L)</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
-colour2 * (N.L) + colour1 + colour1 * (N.L)</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
(colour1-colour2) * (N.L) + colour1</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
((colour0+colour2)/2-colour2) * (N.L) + (colour0+colour2)/2</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
((colour0-colour2)/2) * (N.L) + (colour0+colour2)/2</p>
<p class=MsoNormal style=margin-left:36pt;text-indent:36pt>= same as
hemispherical</p>
<p class=MsoNormal style=text-indent:36pt><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The <span class=SpellE>trilight</span> is very close to wrap-around
lighting when colour2 = black, colour1 = factor*colour0/2. This is only an
approximation, but it�s pretty close as you can see from the demo and from the
following:</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>For N.L &gt;= 0:</p>
<p class=MsoNormal style=text-indent:36pt><span class=SpellE><span class=GramE>trilight</span></span> = colour0 * (N.L) + colour1 * (1-(N.L))</p>
<p class=MsoNormal style=margin-left:36pt;text-indent:36pt>= colour0 *
(N.L) + factor *colour0* (1-(N.L))/2</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
colour0 * ((N.L) + factor /2 - factor *(N.L)/2)</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
colour0 * ((N.L)*(2- factor) + factor))/2</p>
<p class=MsoNormal>For N.L &lt; 0:</p>
<p class=MsoNormal style=text-indent:36pt><span class=SpellE><span class=GramE>trilight</span></span> = colour1 * (1+(N.L)) - colour2 * (N.L)</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
colour1 * (1<span class=GramE>+(</span>N.L))</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
factor *colour0 * (1<span class=GramE>+(</span>N.L))/2</p>
<p class=MsoNormal style=text-indent:36pt><span style=mso-tab-count:1>����������� </span>=
colour0 * (factor /2) * ((N.L<span class=GramE>)+</span>1)</p>
<p class=MsoNormal style=text-indent:36pt><o:p>&nbsp;</o:p></p>
<p class=MsoNormal style=text-indent:36pt><span class=GramE>hemi</span> =
colour0 * clamp((N.L)+factor)/(1+factor)</p>
<p class=MsoNormal style=text-indent:36pt><o:p>&nbsp;</o:p></p>
<p class=MsoNormal style=text-indent:36pt><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>Note that when factor is 0 or 1, the two match exactly. The
greatest discrepancy is when factor=0.5. Looking at the Excel spreadsheet you
can see how the two curves differ at this value, and by toggling on and off <span class=SpellE>trilight</span> emulation in the demo, you can see that there is a
redistribution of shade from light to dark areas, causing a slight washing-out
of contrast. However, changing the �factor� value is done in response to moving
from a stark, purely-<span class=SpellE>Lambertian</span> lighting environment
into an environment with more back-lighting from indirect bounces, so the whole
thing is just an approximation anyway. As previously mentioned, many games just
hard-wire the factor to be 1.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<h3>Advantages of the <span class=SpellE>Trilight</span> model</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The first advantage to using the <span class=SpellE>trilight</span>
type is that it can emulate all these lighting types without changing shaders,
which reduces the cost of rendering calls and also reduces the combinatorial
nightmare that many coders using shader face.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>But the most fundamental advantage is that the code can
continuously blend between them as required simply by blending the values of
the three colours together for each light type. So you can have a light that is
partially <span class=SpellE>Lambertian</span> and partially bi-directional,
and lerp between the two under <span class=SpellE>gameplay</span> or location
or scripting control.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>In general, any time two different systems can be unified
and parameterised, and you can blend smoothly between them, the life of a coder
gets that little bit simpler.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<h3>The Demo</h3>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>You probably want to make the demo <span class=SpellE>fullscreen</span>
� <span class=GramE>there�s</span> a lot of sliders in the bottom right. From
top to bottom:</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<ul style=margin-top:0cm type=disc>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">The
 three colours, each with a red, green and blue slider. Move the slides to
 change the colours. Some light types don�t use some of the colours.</li>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">The
 light factor � only used for the wraparound light type. 0 = no wraparound,
 1= full wraparound.</li>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">The
 light type � <span class=GramE>this switches</span> between the five light
 types in this article.</li>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">Enable
 <span class=SpellE>trilight</span> emulation. When selected, this uses a <span class=SpellE>trilight</span> emulation of the light type instead of using
 the real lighting equation. As said above, this emulation is perfect
 except in the case of the wraparound light � by selecting that type and
 toggling this button on and off, you can see the slight differences.</li>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">Enable
 <span class=SpellE>preshaders</span>. <span class=SpellE>Ooops</span> �
 left over from the D3D demo I started with. Ignore it.</li>
 <li class=MsoNormal style="mso-list:l0 level1 lfo1;tab-stops:list 36pt">Change
 model. Toggles the model between a spiky-haired young lady and a sphere.</li>
</ul>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>LMB: rotate model.</p>
<p class=MsoNormal>MMB: rotate camera.</p>
<p class=MsoNormal>RMB: rotate light.</p>
<p class=MsoNormal><o:p>&nbsp;</o:p></p>
<p class=MsoNormal>The shader code used is in <span class=SpellE>trilight.fx</span>
if you wish to inspect it.<o:p></o:p></p>
</div>
</o:smarttagtype><div id=HUABAN_WIDGETS><div class=HUABAN-f-button style=display:none>采集</div><style class=sf-hidden>#HUABAN_WIDGETS{font-family:"helvetica neue",arial,sans-serif;color:#444;font-size:14px}#HUABAN_WIDGETS *{box-sizing:content-box}#HUABAN_WIDGETS .HUABAN-f-button{position:absolute;z-index:9999999999998;box-shadow:0 0 0 2px rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;cursor:pointer;padding:0 12px;height:30px;line-height:30px;border-radius:2px;font-size:14px}#HUABAN_WIDGETS .HUABAN-f-button:hover{background-color:#999;background-color:rgba(0,0,0,.5)}#HUABAN_WIDGETS .HUABAN-f-button:active{background-color:rgba(0,0,0,.6)}<!--</style></div>